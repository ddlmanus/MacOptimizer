# Mac优化大师 v4.0.3 更新日志

**发布日期**: 2026年1月12日

## 🔴 紧急安全修复

本版本修复了多个严重的安全漏洞，强烈建议所有用户立即更新。

### 问题描述

v4.0.2 及更早版本存在以下严重问题：
- 智能扫描清理可能删除用户视频文件
- 清理后导致 90% 的应用程序无法启动（包括 Edge、Chrome 等）
- 删除应用的语言文件导致代码签名破坏

---

## 修复内容

### 1. 智能扫描模块 (SmartCleanerService)

| 问题 | 修复 |
|------|------|
| 6个文件数组删除时不检查用户是否勾选 | 添加 `isSelected` 检查 |
| 重复文件/相似照片组不检查选择状态 | 添加 `isSelected` 检查 |
| 删除应用 .lproj 文件破坏代码签名 | **禁用**本地化文件清理 |
| 删除已安装应用的缓存文件 | 跳过已安装应用的缓存 |
| 扫描已卸载应用残留可能误删 | **禁用**残留扫描 |
| 大文件默认勾选导致误删 | 大文件默认**不勾选** |
| 后台应用优化导致应用崩溃 | **禁用**性能优化功能 |

### 2. 安全防护 (SafetyGuard)

新增受保护目录：
- `~/Movies` - 用户视频
- `~/Music` - 用户音乐
- `~/Pictures` - 用户图片
- `~/Documents` - 用户文档
- `~/Desktop` - 桌面
- `~/Downloads` - 下载
- `/Applications` - 应用程序

### 3. 深度扫描模块 (DeepCleanScanner)

| 问题 | 修复 |
|------|------|
| `deleteSingleItem()` 绕过安全检查 | 添加 SafetyGuard 检查 |
| 直接删除文件无法恢复 | 改用 `trashItem` 移至废纸篓 |

### 4. 系统垃圾模块 (JunkCleaner)

| 问题 | 修复 |
|------|------|
| 语言文件扫描删除应用 .lproj | **完全禁用**语言文件类型 |

---

## 技术细节

### 已禁用的危险功能

以下功能因安全风险已被禁用，待后续版本安全重构后恢复：

1. **本地化文件清理** - 删除 .lproj 会破坏 macOS 代码签名
2. **语言文件清理** - 同上
3. **性能优化（后台应用关闭）** - 可能导致应用数据丢失
4. **已卸载应用残留扫描** - 误判率过高

### 代码变更统计

- **SmartCleanerService.swift** - 8 处删除循环修复
- **SafetyGuard.swift** - 8 个新增保护路径
- **DeepCleanScanner.swift** - 1 处安全检查修复
- **JunkCleaner.swift** - 1 处功能禁用

---

## 升级建议

⚠️ **强烈建议**所有用户升级到 v4.0.3 版本

如果您在使用 v4.0.2 后遇到应用无法启动的问题：
1. 从备份恢复应用程序
2. 或重新下载/安装受影响的应用

---

## 下载

- Apple Silicon (M芯片): `Mac优化大师_v4.0.3_AppleSilicon.dmg`
- Intel 版本: `Mac优化大师_v4.0.3_Intel.dmg`
